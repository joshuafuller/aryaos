# Node-RED
#
# Copyright Sensors & Signals LLC https://www.snstac.com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

- name: Download update-nodejs-and-nodered installer
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/node-red/linux-installers/master/deb/update-nodejs-and-nodered
    dest: /usr/src/update-nodejs-and-nodered
    mode: "0755"

- name: Create node-red user
  ansible.builtin.user:
    name: node-red
    comment: Node-RED service user
    groups: sudo, adm, video, plugdev, dialout
    append: true
    password: "!"

- name: Copy node-red.sudoers
  ansible.builtin.copy:
    src: "{{ shared_files }}/node-red/node-red.sudoers"
    dest: /etc/sudoers.d/node-red
    mode: "0440"

- name: Run update-nodejs-and-nodered installer
  ansible.builtin.command:
    cmd: /bin/bash /usr/src/update-nodejs-and-nodered --confirm-install --nodered-user=node-red --confirm-root --skip-pi --no-init
    creates: /home/node-red/.node-red
  become: true
  become_user: node-red

- name: Install Node-RED Nodes
  ansible.builtin.command:
    cmd: |
      npm install node-red-contrib-tak
      npm install node-red-contrib-sitx
      npm install node-red-contrib-tfr2cot
      npm install node-red-contrib-web-worldmap
      npm install node-red-dashboard
      npm install node-red-node-ui-table
      npm install node-red-contrib-ui-upload
      npm install node-red-contrib-qrcode-generator
      npm install axios
    chdir: /home/node-red/.node-red
    creates: /home/node-red/.node-red/node_modules/node-red-contrib-tak
  become: true
  become_user: node-red

- name: Copy aryaos_flows.json to aryaos_flows.json
  ansible.builtin.copy:
    src: "{{ shared_files }}/node-red/aryaos_flows.json"
    dest: /home/node-red/.node-red/aryaos_flows.json
    owner: node-red
    group: node-red
    mode: "0640"

- name: Copy aryaos_flows.json to flows.json
  ansible.builtin.copy:
    src: "{{ shared_files }}/node-red/aryaos_flows.json"
    dest: /home/node-red/.node-red/flows.json
    owner: node-red
    group: node-red
    mode: "0640"

- name: Enable node-red service
  ansible.builtin.systemd_service:
    name: nodered.service
    enabled: true
    daemon_reload: true
